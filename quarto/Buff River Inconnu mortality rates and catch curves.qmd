---
title: "Buff River Inconnu mortality rates and catch curves"
author: "Chelsey Lumb"
format: html
date: "`r Sys.Date()`"
editor: visual
---

Created new quarto file for Buffalo River Inconnu mortality rate estimates because added some data prep/wrangling code to get data file ready

```{r}
#| label: note - don't need knitr code chunk at the beginning of quarto file to be able to render 
#| include: false
```


```{r}
#| label: load packages
#| include: false

library(tidyverse) #ggplot2 and purrr part of tidyverse
library(janitor)
library(here)
library(fs) # Series of tools to work with file-systems, a bit like {here}

library (FSA)
library(knitr)     # to use kable() function to format tables
library(gt)        # to format tables
library(readr)     # to save csv data files to data folder 
```

# Load data and look at data file and data types for wrangling

```{r}
#| label: load data
#| include: false

# Should load raw data and use tally to count catch by year and age in R
# Examples in R4EnviroSci -> week_10_part_1_counting.Rmd

inco_buffriv_original <- read_csv(here("data", "buffriv_inco_catchage.csv"))

str(inco_buffriv_original)

print(inco_buffriv_original)
```

# Prepare data for mortality rate estimates
1) pivot longer
2) reorder columns
3) arrange by year, from earliest to latest (1947 to 2022)
4) remove years with no ages, 1995 and 2011 
2) replace NAs with zeros
3) pivot wider again to check catch by year and age matches data in excel (wrangling done right)


```{r}
#| label: data prep
#| include: false

inco <- inco_buffriv_original |> 
  pivot_longer(!age,
               names_to = "year", 
               values_to = "catch") |> 
  select(year, age, catch) |>                                  # reorder columns so year, age, catch
  arrange(year) |>                                             # arrange catch data by year
  filter(year != 1995 & year != 2011) |>                       # filter out years with no age data != 1995 or 2011
  mutate(catch = ifelse(is.na(catch), 0, catch))               # replace nas in catch with zeros
  
#  print(inco)


summary_tbl <- inco %>% 
  pivot_wider(names_from = year, values_from = catch, values_fill = 0) 

# pivot wider, check data right, matches tbl in excel


# readr::write_csv(summary_tbl, here("data", "inco_buffriv_agefreq.csv"))    # save final buff river age freq data file 
```
 
 
```{r}
#| label: plot data by year, identify descending limb of catch curve 
#| echo: false
#| warning: false
#| message: false

# Add code to get n - number of samples each year for table
  
inco |>   

    filter(year >= 1947 & year <=1979) |>   
 
    ggplot() +
  
  facet_wrap(~ year) +
  geom_point(aes(x = age, y = catch)) +
  
  scale_x_continuous(name="Age (yrs)",expand=expansion(mult=0.02)) +
  scale_y_continuous(name="Catch",expand=expansion(mult=0.02))


inco |>   

    filter(year >= 1980 & year <=1989) |>   
 
    ggplot() +
  
  facet_wrap(~ year) +
  geom_point(aes(x = age, y = catch)) +
  
  scale_x_continuous(name="Age (yrs)",expand=expansion(mult=0.02)) +
  scale_y_continuous(name="Catch",expand=expansion(mult=0.02))


inco |>   

    filter(year >= 1990 & year <=1999) |>   
 
    ggplot() +
  
  facet_wrap(~ year) +
  geom_point(aes(x = age, y = catch)) +
  
  scale_x_continuous(name="Age (yrs)",expand=expansion(mult=0.02)) +
  scale_y_continuous(name="Catch",expand=expansion(mult=0.02))


inco |>   

    filter(year >= 2000 & year <=2009) |>   
 
    ggplot() +
  
  facet_wrap(~ year) +
  geom_point(aes(x = age, y = catch)) +
  
  scale_x_continuous(name="Age (yrs)",expand=expansion(mult=0.02)) +
  scale_y_continuous(name="Catch",expand=expansion(mult=0.02))


inco |>   

    filter(year >= 2010 & year <=2019) |>   
 
    ggplot() +
  
  facet_wrap(~ year) +
  geom_point(aes(x = age, y = catch)) +
  
  scale_x_continuous(name="Age (yrs)",expand=expansion(mult=0.02)) +
  scale_y_continuous(name="Catch",expand=expansion(mult=0.02))


inco |>   

    filter(year >= 2020 & year <=2022) |>   
 
    ggplot() +
  
  facet_wrap(~ year) +
  geom_point(aes(x = age, y = catch)) +
  
  scale_x_continuous(name="Age (yrs)",expand=expansion(mult=0.02)) +
  scale_y_continuous(name="Catch",expand=expansion(mult=0.02))
```
 
 
```{r}
#| label: create data file with peak catch and descending limb for each year - code from chatGPT
#| include: false


# Find the age with the highest catch for each year
max_catch_ages <- inco %>%
  group_by(year) %>%
  summarise(max_age = age[which.max(catch)])

# Create a list to store the subsetted data for each year
subset_data_list <- list()

# Loop through each year and subset the data
for (i in 1:nrow(max_catch_ages)) {
  year <- max_catch_ages$year[i]
  max_catch_age <- max_catch_ages$max_age[i]
  subset_data_list[[i]] <- inco[inco$year == year & inco$age >= max_catch_age, ]
}

# Combine the subsetted data for all years into a single data frame
subset_data <- do.call(rbind, subset_data_list)

# Print the subsetted data
print(subset_data)
```
 
# Plot to check ages included in reduced data frame, ages from peak + descending limb of catch curves

```{r}
#| label: plot descending limbs 
#| echo: false
#| warning: false
#| message: false

subset_data |>  

filter(year >= 1947 & year <=1979) |>   

ggplot(mapping=aes(x=age,y=catch)) +
  geom_point(size=2) +
  geom_line(alpha=0.1,linewidth=1.5) +
  facet_wrap(~ year) +
  theme_bw() + theme(legend.position="none")


subset_data |>  

filter(year >= 1980 & year <=1989) |>   

ggplot(mapping=aes(x=age,y=catch)) +
  geom_point(size=2) +
  geom_line(alpha=0.1,linewidth=1.5) +
  facet_wrap(~ year) +
  theme_bw() + theme(legend.position="none")


subset_data |>  

filter(year >= 1990 & year <=1999) |>   

ggplot(mapping=aes(x=age,y=catch)) +
  geom_point(size=2) +
  geom_line(alpha=0.1,linewidth=1.5) +
  facet_wrap(~ year) +
  theme_bw() + theme(legend.position="none")


subset_data |>  

filter(year >= 2000 & year <=2009) |>   

ggplot(mapping=aes(x=age,y=catch)) +
  geom_point(size=2) +
  geom_line(alpha=0.1,linewidth=1.5) +
  facet_wrap(~ year) +
  theme_bw() + theme(legend.position="none")


subset_data |>  

filter(year >= 2010 & year <=2019) |>   

ggplot(mapping=aes(x=age,y=catch)) +
  geom_point(size=2) +
  geom_line(alpha=0.1,linewidth=1.5) +
  facet_wrap(~ year) +
  theme_bw() + theme(legend.position="none")


subset_data |>  

filter(year >= 2020 & year <=2022) |>   

ggplot(mapping=aes(x=age,y=catch)) +
  geom_point(size=2) +
  geom_line(alpha=0.1,linewidth=1.5) +
  facet_wrap(~ year) +
  theme_bw() + theme(legend.position="none")


```

 
 